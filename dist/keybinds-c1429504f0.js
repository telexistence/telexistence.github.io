!function(e){"object"==typeof module&&module.exports&&(module.exports=e(global,global.engine,!1)),"function"==typeof define?define(function(){return e(window,window.engine,!0)}):window.engine=e(window,window.engine,!0)}(function(e,t,n){"use strict";function r(){this.events={}}function o(e,t){this.code=e,this.context=t}function i(e,t,n){var r=function(){e.call(t,n)};setTimeout(r)}function a(){this.emitter=new r,this.state=u,this.result=null}function s(e){return function(){return e}}function c(e){var n=function(){var n=Array.prototype.slice.call(arguments);return n.splice(0,0,e,this._id),t.call.apply(t,n)};return n}r.prototype._createClear=function(e,t,n){return function(){var r=e.events[t];if(r){var o=r.indexOf(n);-1!=o&&(r.splice(o,1),0===r.length&&delete e.events[t])}}},r.prototype.on=function(e,t,n){var r=this.events[e];void 0===r&&(r=this.events[e]=[]);var i=new o(t,n||this);return r.push(i),{clear:this._createClear(this,e,i)}},r.prototype.off=function(e,t,n){var r=this.events[e];if(void 0!==r){n=n||this;var o,i=r.length;for(o=0;i>o;++o){var a=r[o];if(a.code==t&&a.context==n)break}i>o&&(r.splice(o,1),0===r.length&&delete this.events[e])}},r.prototype.trigger=function(e){var t=this.events[e];if(void 0!==t){var n=Array.prototype.slice.call(arguments,1);t.forEach(function(e){e.code.apply(e.context,n)})}},r.prototype.merge=function(e){var t,n=this.events,r=e.events,o=Array.prototype.push;for(var i in r)t=n[i]=n[i]||[],o.apply(t,r[i])};var u="pending",l="fulfilled",h="broken";a.prototype.resolve=function(e){this.state=l,this.result=e,this.emitter.trigger(l,e)},a.prototype.reject=function(e){this.state=h,this.result=e,this.emitter.trigger(h,e)},a.prototype.success=function(e,t){return this.state!==l?this.emitter.on(l,e,t):i(e,t||this,this.result),this},a.prototype.always=function(e,t){return this.success(e,t),this.otherwise(e,t),this},a.prototype.otherwise=function(e,t){return this.state!==h?this.emitter.on(h,e,t):i(e,t||this,this.result),this},a.prototype.merge=function(e){if(this.state===u)this.emitter.merge(e.emitter);else{var t=e.emitter.events[this.state],n=this;void 0!==t&&t.forEach(function(e){e.code.call(e.context,n.result)})}},a.prototype.make_chain=function(e,t,n){return function(r){var o;try{o=e.code.call(e.context,r),o instanceof a?o.merge(t):this.state===n?t.resolve(o):t.reject(o)}catch(i){t.reject(i)}}},a.prototype.then=function(e,t){var n=new a,r=new o(e||s(this),this);this.success(this.make_chain(r,n,l),this);var i=new o(t||s(this),this);return this.otherwise(this.make_chain(i,n,h),this),n};var d=void 0!==t;t=t||{},t.events={};for(var v in r.prototype)t[v]=r.prototype[v];t._trigger=r.prototype.trigger;var p=Array.prototype.concat;return t.trigger=function(e){if(this._trigger.apply(this,arguments),void 0===this._eventHandles[e]&&this.IsAttached&&this.TriggerEvent.apply(this,arguments),void 0!==this.events.all){var t=p.apply(["all"],arguments);this._trigger.apply(this,t)}},t.IsAttached=d,t._BindingsReady=!1,t._WindowLoaded=!1,t._RequestId=0,t._ActiveRequests={},t.IsAttached||(t.SendMessage=function(e,n){var r=Array.prototype.slice.call(arguments,2),o=t._ActiveRequests[n];delete t._ActiveRequests[n],r.push(o);var i=function(e,n){return function(){var r=t["Mock_"+e];if(void 0!==r){var o=function(){r.apply(t,n)};window.setTimeout(o,16)}}}(e,r);window.setTimeout(i,16)},t.TriggerEvent=function(){var e,n=Array.prototype.slice.call(arguments);n[0]="Fake_"+n[0],e=function(e){return function(){t.trigger.apply(t,e)}}(n),window.setTimeout(e,16)},t.BindingsReady=function(){t._OnReady()},t.__observeLifetime=function(){}),t.createDeferred=void 0===e.engineCreateDeferred?function(){return new a}:e.engineCreateDeferred,t.call=function(){t._RequestId++;var e=t._RequestId,n=t.createDeferred();t._ActiveRequests[e]=n;var r=Array.prototype.slice.call(arguments);return r.splice(1,0,e),t.SendMessage.apply(this,r),n},t._Result=function(e){var n=t._ActiveRequests[e];if(void 0!==n){delete t._ActiveRequests[e];var r=Array.prototype.slice.call(arguments);r.shift(),n.resolve.apply(n,r)}},t._Errors=["Success","ArgumentType","NoSuchMethod","NoResult"],t._ForEachError=function(e,t){for(var n=e.length,r=0;n>r;++r)t(e[r].first,e[r].second)},t._MapErrors=function(e){for(var n=e.length,r=0;n>r;++r)e[r].first=t._Errors[e[r].first]},t._TriggerError=function(e,n){t.trigger("Error",e,n)},t._OnError=function(e,n){if(t._MapErrors(n),null===e||0===e)t._ForEachError(n,t._TriggerError);else{var r=t._ActiveRequests[e];delete t._ActiveRequests[e],r.reject(n)}},t._eventHandles={},t._Register=function(e){var n=function(e,t){return function(){var n=[e];n.push.apply(n,arguments),t.TriggerEvent.apply(this,n)}}(e,t);t._eventHandles[e]=t.on(e,n)},t._removeEventThunk=function(e){var n=t._eventHandles[e];n.clear(),delete t._eventHandles[e]},t._Unregister=function(e){"string"==typeof e?t._removeEventThunk(e):e.forEach(t._removeEventThunk,t)},t._boundTypes={},t._createInstance=function(e){var n=e[0],r=e[1],o=e[2],i=t._boundTypes[n];void 0===i&&(i=function(e){this._id=e},i.prototype.__Type=n,o.forEach(function(e){i.prototype[e]=c(n+"_"+e)}),t._boundTypes[n]=i);var a=new i(r);return t.__observeLifetime(a),a},t._OnReady=function(){t._BindingsReady=!0,t._WindowLoaded&&t.trigger("Ready")},t._OnWindowLoaded=function(){t._WindowLoaded=!0,t._BindingsReady&&t.trigger("Ready")},n?e.onload=function(e){return function(){e&&e(),t._OnWindowLoaded()}}(e.onload):t._WindowLoaded=!0,t._coherentGlobalCanvas=document.createElement("canvas"),t._coherentGlobalCanvas.id="coherentGlobalCanvas",t._coherentGlobalCanvas.width=1,t._coherentGlobalCanvas.height=1,t._coherentGlobalCanvas.style.zIndex=0,t._coherentGlobalCanvas.style.position="absolute",t._coherentGlobalCanvas.style.border="0px solid",t._coherentLiveImageData=[],t._coherentCreateImageData=function(e,n){var r=t._coherentGlobalCanvas.getContext("2d"),o=r.coherentCreateImageData(n);t._coherentLiveImageData[e]=o},t._coherentUpdatedImageData=function(e){t._coherentLiveImageData[e].coherentUpdate();for(var n=document.getElementsByTagName("canvas"),r=0;r<n.length;++r)n[r].onEngineImageDataUpdated&&n[r].onEngineImageDataUpdated(e,t._coherentLiveImageData[e])},t.on("_coherentCreateImageData",t._coherentCreateImageData),t.on("_coherentUpdatedImageData",t._coherentUpdatedImageData),t.on("_Result",t._Result,t),t.on("_Register",t._Register,t),t.on("_Unregister",t._Unregister,t),t.on("_OnReady",t._OnReady,t),t.on("_OnError",t._OnError,t),t.BindingsReady(),t});